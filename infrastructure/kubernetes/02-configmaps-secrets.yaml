# ============================================================================
# SHAKA API - CONFIGMAPS E SECRETS
# Arquivo: infrastructure/kubernetes/02-configmaps-secrets.yaml
# Objetivo: Configurações e credenciais por ambiente
# ============================================================================

# ============================================================================
# CONFIGMAPS - CONFIGURAÇÕES NÃO-SENSÍVEIS
# ============================================================================

# DESENVOLVIMENTO - ConfigMap
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: shaka-api-config
  namespace: shaka-dev
  labels:
    app: shaka-api
    environment: development
data:
  # Node.js
  NODE_ENV: "development"
  PORT: "3000"
  
  # API Configuration
  API_VERSION: "v1"
  API_PREFIX: "/api/v1"
  API_RATE_LIMIT_WINDOW: "900000"      # 15 minutos
  API_RATE_LIMIT_MAX: "1000"           # 1000 requests
  
  # Database
  DB_HOST: "postgres-dev.shaka-dev.svc.cluster.local"
  DB_PORT: "5432"
  DB_NAME: "shaka_dev"
  DB_SSL: "false"
  DB_POOL_MIN: "2"
  DB_POOL_MAX: "10"
  DB_IDLE_TIMEOUT: "30000"
  
  # Redis
  REDIS_HOST: "redis-dev.shaka-dev.svc.cluster.local"
  REDIS_PORT: "6379"
  REDIS_DB: "0"
  REDIS_KEY_PREFIX: "shaka:dev:"
  
  # Cache
  CACHE_TTL: "300"                     # 5 minutos
  CACHE_ENABLED: "true"
  
  # Logs
  LOG_LEVEL: "debug"
  LOG_FORMAT: "json"
  LOG_PRETTY: "true"
  
  # CORS
  CORS_ORIGIN: "*"
  CORS_CREDENTIALS: "true"
  
  # Features Flags
  FEATURE_WEBHOOKS: "true"
  FEATURE_ANALYTICS: "true"
  FEATURE_RATE_LIMIT: "true"
  
  # Monitoring
  METRICS_ENABLED: "true"
  METRICS_PORT: "9090"
  HEALTH_CHECK_PATH: "/health"
  
  # Stripe (Test Mode)
  STRIPE_API_VERSION: "2024-11-20.acacia"
  STRIPE_WEBHOOK_PATH: "/api/v1/webhooks/stripe"

---
# STAGING - ConfigMap
apiVersion: v1
kind: ConfigMap
metadata:
  name: shaka-api-config
  namespace: shaka-staging
  labels:
    app: shaka-api
    environment: staging
data:
  NODE_ENV: "staging"
  PORT: "3000"
  
  API_VERSION: "v1"
  API_PREFIX: "/api/v1"
  API_RATE_LIMIT_WINDOW: "900000"
  API_RATE_LIMIT_MAX: "500"            # Mais restritivo que dev
  
  DB_HOST: "postgres-staging.shaka-staging.svc.cluster.local"
  DB_PORT: "5432"
  DB_NAME: "shaka_staging"
  DB_SSL: "true"
  DB_POOL_MIN: "5"
  DB_POOL_MAX: "20"
  DB_IDLE_TIMEOUT: "30000"
  
  REDIS_HOST: "redis-staging.shaka-staging.svc.cluster.local"
  REDIS_PORT: "6379"
  REDIS_DB: "0"
  REDIS_KEY_PREFIX: "shaka:staging:"
  
  CACHE_TTL: "600"                     # 10 minutos
  CACHE_ENABLED: "true"
  
  LOG_LEVEL: "info"
  LOG_FORMAT: "json"
  LOG_PRETTY: "false"
  
  CORS_ORIGIN: "https://staging.shakaapi.com,https://staging-dashboard.shakaapi.com"
  CORS_CREDENTIALS: "true"
  
  FEATURE_WEBHOOKS: "true"
  FEATURE_ANALYTICS: "true"
  FEATURE_RATE_LIMIT: "true"
  
  METRICS_ENABLED: "true"
  METRICS_PORT: "9090"
  HEALTH_CHECK_PATH: "/health"
  
  STRIPE_API_VERSION: "2024-11-20.acacia"
  STRIPE_WEBHOOK_PATH: "/api/v1/webhooks/stripe"

---
# PRODUCTION - ConfigMap
apiVersion: v1
kind: ConfigMap
metadata:
  name: shaka-api-config
  namespace: shaka-prod
  labels:
    app: shaka-api
    environment: production
data:
  NODE_ENV: "production"
  PORT: "3000"
  
  API_VERSION: "v1"
  API_PREFIX: "/api/v1"
  API_RATE_LIMIT_WINDOW: "900000"
  API_RATE_LIMIT_MAX: "100"            # Mais restritivo (será overridden por tier)
  
  DB_HOST: "postgres-prod.shaka-prod.svc.cluster.local"
  DB_PORT: "5432"
  DB_NAME: "shaka_production"
  DB_SSL: "true"
  DB_SSL_REJECT_UNAUTHORIZED: "true"
  DB_POOL_MIN: "10"
  DB_POOL_MAX: "50"
  DB_IDLE_TIMEOUT: "30000"
  DB_CONNECTION_TIMEOUT: "5000"
  
  REDIS_HOST: "redis-prod.shaka-prod.svc.cluster.local"
  REDIS_PORT: "6379"
  REDIS_DB: "0"
  REDIS_KEY_PREFIX: "shaka:prod:"
  REDIS_SENTINEL: "true"
  
  CACHE_TTL: "3600"                    # 1 hora
  CACHE_ENABLED: "true"
  
  LOG_LEVEL: "warn"
  LOG_FORMAT: "json"
  LOG_PRETTY: "false"
  
  CORS_ORIGIN: "https://shakaapi.com,https://dashboard.shakaapi.com,https://app.shakaapi.com"
  CORS_CREDENTIALS: "true"
  
  FEATURE_WEBHOOKS: "true"
  FEATURE_ANALYTICS: "true"
  FEATURE_RATE_LIMIT: "true"
  
  METRICS_ENABLED: "true"
  METRICS_PORT: "9090"
  HEALTH_CHECK_PATH: "/health"
  
  STRIPE_API_VERSION: "2024-11-20.acacia"
  STRIPE_WEBHOOK_PATH: "/api/v1/webhooks/stripe"

---
# ============================================================================
# SECRETS - CREDENCIAIS SENSÍVEIS
# ATENÇÃO: Em produção real, use Sealed Secrets ou External Secrets Operator
# Os valores abaixo são placeholders - devem ser substituídos
# ============================================================================

# DESENVOLVIMENTO - Secrets
---
apiVersion: v1
kind: Secret
metadata:
  name: shaka-api-secrets
  namespace: shaka-dev
  labels:
    app: shaka-api
    environment: development
type: Opaque
stringData:
  # Database
  DB_USER: "shaka_dev"
  DB_PASSWORD: "dev_password_change_me"
  DB_URL: "postgresql://shaka_dev:dev_password_change_me@postgres-dev.shaka-dev.svc.cluster.local:5432/shaka_dev"
  
  # Redis
  REDIS_PASSWORD: ""
  
  # JWT
  JWT_SECRET: "dev_jwt_secret_min_32_chars_long_change_in_production"
  JWT_EXPIRES_IN: "7d"
  JWT_REFRESH_SECRET: "dev_refresh_secret_min_32_chars_change_me"
  JWT_REFRESH_EXPIRES_IN: "30d"
  
  # API Keys (Master keys para testes)
  API_MASTER_KEY: "sk_test_dev_master_key_change_me"
  ADMIN_API_KEY: "admin_dev_key_change_me"
  
  # Stripe (Test Mode)
  STRIPE_SECRET_KEY: "sk_test_51XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX"
  STRIPE_WEBHOOK_SECRET: "whsec_dev_XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX"
  STRIPE_PUBLISHABLE_KEY: "pk_test_51XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX"
  
  # Email (Development - usa Mailtrap ou similar)
  SMTP_HOST: "smtp.mailtrap.io"
  SMTP_PORT: "2525"
  SMTP_USER: "your_mailtrap_user"
  SMTP_PASSWORD: "your_mailtrap_password"
  EMAIL_FROM: "dev@shakaapi.com"
  
  # Encryption
  ENCRYPTION_KEY: "dev_encryption_key_32_characters_minimum_change_me"

---
# STAGING - Secrets
apiVersion: v1
kind: Secret
metadata:
  name: shaka-api-secrets
  namespace: shaka-staging
  labels:
    app: shaka-api
    environment: staging
type: Opaque
stringData:
  DB_USER: "shaka_staging"
  DB_PASSWORD: "staging_password_CHANGE_ME"
  DB_URL: "postgresql://shaka_staging:staging_password_CHANGE_ME@postgres-staging.shaka-staging.svc.cluster.local:5432/shaka_staging?ssl=true"
  
  REDIS_PASSWORD: "staging_redis_password_CHANGE_ME"
  
  JWT_SECRET: "staging_jwt_secret_MUST_BE_AT_LEAST_32_CHARACTERS_LONG_CHANGE_ME"
  JWT_EXPIRES_IN: "1d"
  JWT_REFRESH_SECRET: "staging_refresh_secret_ALSO_32_CHARS_MIN_CHANGE_ME"
  JWT_REFRESH_EXPIRES_IN: "7d"
  
  API_MASTER_KEY: "sk_test_staging_master_key_CHANGE_ME"
  ADMIN_API_KEY: "admin_staging_key_CHANGE_ME"
  
  STRIPE_SECRET_KEY: "sk_test_51STAGING_KEY_XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX"
  STRIPE_WEBHOOK_SECRET: "whsec_staging_XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX"
  STRIPE_PUBLISHABLE_KEY: "pk_test_51STAGING_KEY_XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX"
  
  SMTP_HOST: "smtp.sendgrid.net"
  SMTP_PORT: "587"
  SMTP_USER: "apikey"
  SMTP_PASSWORD: "SG.STAGING_KEY_XXXXXXXXXXXXXXXXXXXXXX"
  EMAIL_FROM: "staging@shakaapi.com"
  
  ENCRYPTION_KEY: "staging_encryption_key_32_chars_min_CHANGE_ME"

---
# PRODUCTION - Secrets
apiVersion: v1
kind: Secret
metadata:
  name: shaka-api-secrets
  namespace: shaka-prod
  labels:
    app: shaka-api
    environment: production
type: Opaque
stringData:
  DB_USER: "shaka_production"
  DB_PASSWORD: "PROD_PASSWORD_USE_STRONG_PASSWORD_HERE"
  DB_URL: "postgresql://shaka_production:PROD_PASSWORD_USE_STRONG_PASSWORD_HERE@postgres-prod.shaka-prod.svc.cluster.local:5432/shaka_production?ssl=true&sslmode=require"
  
  REDIS_PASSWORD: "PROD_REDIS_STRONG_PASSWORD_HERE"
  
  JWT_SECRET: "PRODUCTION_JWT_SECRET_MINIMUM_64_CHARACTERS_HIGHLY_RANDOM_STRING_HERE"
  JWT_EXPIRES_IN: "1h"
  JWT_REFRESH_SECRET: "PRODUCTION_REFRESH_SECRET_ALSO_64_CHARS_MINIMUM_DIFFERENT_FROM_JWT"
  JWT_REFRESH_EXPIRES_IN: "7d"
  
  API_MASTER_KEY: "sk_live_PRODUCTION_MASTER_KEY_HIGHLY_SECURE"
  ADMIN_API_KEY: "admin_prod_HIGHLY_SECURE_KEY_HERE"
  
  # Stripe LIVE Mode
  STRIPE_SECRET_KEY: "sk_live_51PRODUCTION_LIVE_KEY_XXXXXXXXXXXXXXXXXXXXXXXXXXXXXX"
  STRIPE_WEBHOOK_SECRET: "whsec_PRODUCTION_WEBHOOK_SECRET_XXXXXXXXXXXXXXXXX"
  STRIPE_PUBLISHABLE_KEY: "pk_live_51PRODUCTION_LIVE_KEY_XXXXXXXXXXXXXXXXXXXXXXXXXXXXXX"
  
  SMTP_HOST: "smtp.sendgrid.net"
  SMTP_PORT: "587"
  SMTP_USER: "apikey"
  SMTP_PASSWORD: "SG.PRODUCTION_SENDGRID_API_KEY_HERE"
  EMAIL_FROM: "noreply@shakaapi.com"
  
  ENCRYPTION_KEY: "PRODUCTION_ENCRYPTION_KEY_64_CHARS_MINIMUM_HIGHLY_SECURE"

---
# ============================================================================
# CONFIGMAP - PLAN CONFIGURATIONS (Tiers de Subscription)
# ============================================================================

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: subscription-plans
  namespace: shaka-prod
  labels:
    app: shaka-api
    component: configuration
data:
  plans.json: |
    {
      "starter": {
        "name": "Starter",
        "price": 0,
        "currency": "USD",
        "limits": {
          "requestsPerDay": 1000,
          "requestsPerMonth": 30000,
          "rateLimit": 10,
          "burstLimit": 20,
          "maxApiKeys": 2,
          "webhooks": false,
          "analytics": "basic",
          "support": "community"
        }
      },
      "pro": {
        "name": "Pro",
        "price": 29,
        "currency": "USD",
        "stripePriceId": "price_XXXXXXXXXXXXXX",
        "limits": {
          "requestsPerDay": 100000,
          "requestsPerMonth": 3000000,
          "rateLimit": 100,
          "burstLimit": 200,
          "maxApiKeys": 10,
          "webhooks": true,
          "webhookRetries": 3,
          "analytics": "advanced",
          "support": "email"
        }
      },
      "business": {
        "name": "Business",
        "price": 99,
        "currency": "USD",
        "stripePriceId": "price_YYYYYYYYYYYYYY",
        "limits": {
          "requestsPerDay": 1000000,
          "requestsPerMonth": 30000000,
          "rateLimit": 1000,
          "burstLimit": 2000,
          "maxApiKeys": 50,
          "webhooks": true,
          "webhookRetries": 5,
          "analytics": "premium",
          "customDomain": true,
          "support": "priority"
        }
      },
      "enterprise": {
        "name": "Enterprise",
        "price": null,
        "currency": "USD",
        "limits": {
          "requestsPerDay": -1,
          "requestsPerMonth": -1,
          "rateLimit": 10000,
          "burstLimit": 20000,
          "maxApiKeys": -1,
          "webhooks": true,
          "webhookRetries": 10,
          "analytics": "enterprise",
          "customDomain": true,
          "dedicatedSupport": true,
          "sla": "99.99%",
          "support": "24/7"
        }
      }
    }

---
# ============================================================================
# CONFIGMAP - RATE LIMIT RULES (Detailed per endpoint)
# ============================================================================

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: rate-limit-rules
  namespace: shaka-prod
  labels:
    app: shaka-api
    component: configuration
data:
  rules.json: |
    {
      "global": {
        "windowMs": 900000,
        "message": "Too many requests, please try again later."
      },
      "endpoints": {
        "/api/v1/auth/login": {
          "windowMs": 900000,
          "max": 5,
          "message": "Too many login attempts, please try again in 15 minutes."
        },
        "/api/v1/auth/register": {
          "windowMs": 3600000,
          "max": 3,
          "message": "Too many registration attempts from this IP."
        },
        "/api/v1/auth/forgot-password": {
          "windowMs": 3600000,
          "max": 3,
          "message": "Too many password reset requests."
        },
        "/api/v1/webhooks/*": {
          "windowMs": 60000,
          "max": 100,
          "skipFailedRequests": true
        }
      }
    }
